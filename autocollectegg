-- // console
local console = {}

function console.add(name, color)
    console[name] = function(...)

        local args = {...}

        for i,v in next, args do
            args[i] = tostring(v)
        end

        local message = table.concat(args, ' ')

        local http_request = http and http.request or http_request or request or httprequest
        local response = http_request({
            Url = x0ash.Webhook.URL,
            Method = 'POST',
            Headers = {['Content-Type'] = 'application/json'},
            Body = game:GetService("HttpService"):JSONEncode({
            ["username"] = "x0ash // Egg Premium Logger",
            ["avatar_url"] = "https://cdn.discordapp.com/attachments/1228305747079860235/1228691680820199534/New_Project_4.png?ex=662cf74c&is=661a824c&hm=2f30519029920599c40ef4b2509f0df6724f57936dcb11279bb4c99313a6019c&",
                ["embeds"] = {{
                    ["title"] = "Notification",
                    ["description"] = "",
                    ["type"] = "rich",
                    ["color"] = color,
                    ["fields"] = {
                        {
                            ["name"] = "**Information**",
                            ["value"] = message,
                            ["inline"] = true
                        },
                    },
                }}
            })
        });
    end
end

local Info_LogsPath = x0ash.Webhook.Info_Logs
local Info_WarningsPath = x0ash.Webhook.Info_Warnings
local Info_ErrorsPath = x0ash.Webhook.Info_Errors

console.add('error', Info_ErrorsPath.Color)
console.add('warn', Info_WarningsPath.Color)
console.add('info', Info_LogsPath.Color)

-- // init

if not isfolder('x0ash_farm') then
    console.info("Created 'x0ash_farm', 'x0ash_farm/last.txt', 'x0ash_farm/looted.txt'")
    makefolder('x0ash_farm')
    writefile('x0ash_farm/last.txt', tostring(0))
    writefile('x0ash_farm/looted.txt', '[]')
end

task.spawn(function()
    local str = ('|/-\\'):split('')
    local looted = 0

    for i,v in next, game:GetService('HttpService'):JSONDecode(readfile('x0ash_farm/looted.txt')) do
        looted += 1
    end
end)

if Info_WarningsPath.Enabled then console.warn('waiting for game to load...') end
repeat task.wait() until game:IsLoaded()

-- // variables
local players = game:GetService('Players')
local http = game:GetService('HttpService')
local teleportservice = game:GetService('TeleportService')
local localplayer = players.LocalPlayer
local character = localplayer.Character or localplayer.CharacterAdded:Wait()
local rootpart

-- // functions
function add_looted(jobid)
    local looted = http:JSONDecode(readfile('x0ash_farm/looted.txt'))
    looted[jobid] = tick()
    writefile('x0ash_farm/looted.txt', http:JSONEncode(looted))
end

function get_eggs()
    local eggs = {}

    for i,v in next, workspace.Ignored:GetChildren() do
        if v.Name:match('^Egg') then
            table.insert(eggs, v)
        end
    end

    return eggs
end

function collect_eggs()
    local eggs = get_eggs()

    if Info_LogsPath.Enabled then console.info(#eggs, 'Drake found') end
       
    for i,v in next, eggs do
        firetouchinterest(rootpart, v, 0)
        firetouchinterest(rootpart, v, 1)
        if Info_LogsPath.Enabled then console.info('Drake collected') end
    end
end

function refresh_cache()
    if Info_LogsPath.Enabled then console.info('refreshing Drakes cache') end

    local servers = {}
    local page

    repeat
    local response = http:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/'.. game.PlaceId ..'/servers/Public?sortOrder=Dsc&limit=100' .. (page and '&cursor=' .. page or '')))
    for idx, server in next, response.data do
        table.insert(servers, server)
    end
    page = response.nextPageCursor
    until not page

    writefile('x0ash_farm/last.txt', tostring(tick()))
    writefile(
        'x0ash_farm/server_cache.txt',
        http:JSONEncode(servers)
    )
end

function find_new_server()
    local servers = http:JSONDecode(readfile('x0ash_farm/server_cache.txt'))
    local looted = http:JSONDecode(readfile('x0ash_farm/looted.txt'))
   
    while task.wait(0.5) do

        if Info_LogsPath.Enabled then console.info(('searching %s available servers...'):format(#servers)) end

        for idx, server in next, servers do
            if (
                (server.id ~= game.JobId) and
                (tick() - (looted[server.id] or 0) > 3600) and
                (server.playing) and
                (server.playing > x0ash.Misc.MinimumPlayers) and
                (server.playing < x0ash.Misc.MaximumPlayers)
            ) then
                add_looted(server.id)
                if Info_LogsPath.Enabled then console.info(("Teleporting to drakes '%s' with %s/%s niggas"):format(server.id, server.playing, server.maxPlayers)) end

                xpcall(function()
                    teleportservice:TeleportToPlaceInstance(game.PlaceId, server.id)
                end, function()
                    if Info_ErrorsPath.Enabled then console.error('shit error, redoing') end
                    find_new_server()
                end)

                return
            end
        end   
    end
end

if #get_eggs() == 0 then
    if Info_WarningsPath.Enabled then console.warn('Hood has 0 Drake, ima leave') end
else
    if Info_WarningsPath.Enabled then console.warn('Waiting for Drakes dick') end
    character:WaitForChild('FULLY_LOADED_CHAR')
    rootpart = character:WaitForChild('HumanoidRootPart')   
    collect_eggs()
end

if tick() - tonumber(readfile('x0ash_farm/last.txt')) > x0ash.Misc.RefreshServersDelay then
    refresh_cache()
end

teleportservice.TeleportInitFailed:Connect(function()
    if Info_ErrorsPath.Enabled then console.error('Error error teleport error') end
    find_new_server()
end)

find_new_server()
